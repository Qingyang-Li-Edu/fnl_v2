# 大装机容量场景说明

## 🎯 场景定义

### 你的应用场景
- **PV装机容量**: 500 kW（很大）
- **典型负载**: 10-100 kW（相对较小）
- **核心问题**: PV可发功率 >> 负载 → 容易逆流
- **控制目标**: `P_cmd ≤ Load(t)` 且尽可能接近

## 📊 算法工作原理

### 核心公式
```
安全上界 U_A = STUKF预测下界 - Buffer
性能上界 U_B = STUKF预测均值 - Buffer
PV限发指令 P_cmd = min(U_A, P_max, 上行限速)
```

### 实际案例

#### 场景 1: 负载 50 kW
```
Load = 50 kW
Buffer = 5 kW
P_max = 500 kW

STUKF预测:
  L_med ≈ 50 kW (预测均值)
  L_lb ≈ 48 kW (99.9%置信下界)

计算:
  U_A = 48 - 5 = 43 kW ← 安全上界
  U_B = 50 - 5 = 45 kW ← 性能上界

最终:
  P_cmd = min(43, 500) = 43 kW ✅

结果: PV输出被限制在 43 kW，不会逆流！
```

#### 场景 2: 负载 10 kW（低负载）
```
Load = 10 kW
Buffer = 5 kW
P_max = 500 kW

STUKF预测:
  L_med ≈ 10 kW
  L_lb ≈ 9 kW

计算:
  U_A = 9 - 5 = 4 kW
  U_B = 10 - 5 = 5 kW

最终:
  P_cmd = 4 kW ✅

结果: PV输出被大幅限制在 4 kW
```

#### 场景 3: 负载突然下降
```
时刻 t=0: Load = 50 kW → P_cmd = 43 kW
时刻 t=1: Load = 30 kW → STUKF预测下降

STUKF预测:
  L_lb ≈ 28 kW (提前预测到下降)

计算:
  U_A = 28 - 5 = 23 kW < 43 kW

触发安全旁路:
  P_cmd = 23 kW (立即下调，忽略限速)

结果: 快速降低PV输出，防止逆流
```

## ⚠️ 为什么你看到 P_cmd = 100？

### 可能原因分析

#### 原因 1: P_max 设置错误（已修正）
```
旧设置: P_max = 100 kW
新设置: P_max = 500 kW ✅
```

#### 原因 2: 负载数据问题
```
如果你的负载数据 > 100 kW:
  U_A = Load - Buffer > 95 kW
  旧P_cmd = min(U_A, 100) = 100 kW

解决: 现在P_max=500，会正确计算
```

#### 原因 3: 示例数据负载过大
```
系统生成的示例数据:
  base_load = 50 kW
  + daily_pattern = ±20 kW
  = 30-70 kW

如果 Load = 70 kW:
  U_A = 65 kW
  旧P_cmd = min(65, 100) = 65 kW ✅ 应该不是100

如果你看到100，说明数据问题
```

## 🔧 调试方法

### 步骤 1: 启用调试模式
1. 运行仿真后
2. 展开"图表显示选项"
3. 勾选 ✅ "显示调试信息"
4. 查看计算详情表格

### 步骤 2: 检查关键值
查看表格中的：
- **负载(kW)**: 你的实际负载值
- **安全上界U_A**: 应该 ≈ 负载 - 5
- **PV指令**: 应该 ≈ U_A（在正常情况下）

### 步骤 3: 查看图表
勾选 ✅ "显示安全/性能上界"

应该看到：
- **灰色细线（负载）**: 你的实际负载曲线
- **蓝色粗线（P_cmd）**: 应该贴近但略低于负载
- **红色虚线（U_A）**: 应该 ≈ 负载 - Buffer

如果看到：
- P_cmd 一条直线在 500 → 负载太大或算法问题
- P_cmd = 负载 → Buffer = 0？
- P_cmd << 负载 → 算法正常工作 ✅

## 💡 期望行为

### 正常工作的表现

#### 负载曲线动态变化
```
时间    负载    PV指令    说明
0s      50      45       跟踪良好
10s     45      40       负载降低，PV跟随
20s     30      25       低负载，大幅限制
30s     35      30       负载回升，PV增加
40s     60      55       高负载，放松限制
```

#### 图表应该显示
- P_cmd 曲线**贴近但始终低于**负载曲线
- 两条线之间的垂直距离 ≈ Buffer
- P_cmd 变化**平滑**（受限速控制）

## 📊 测试建议

### 测试 1: 生成低负载数据
修改示例数据生成参数：
```python
base_load = 20  # 降低基准负载
```

应该看到 P_cmd ≈ 15-25 kW

### 测试 2: 上传真实数据
上传你的实际负载数据，应该看到：
- 如果负载 < 100 kW → P_cmd < 负载
- 如果负载在变化 → P_cmd 跟随变化

### 测试 3: 调整 Buffer
- Buffer = 5 → P_cmd ≈ 负载 - 5
- Buffer = 10 → P_cmd ≈ 负载 - 10
- Buffer = 20 → P_cmd ≈ 负载 - 20

## 🎯 预期效果

### 成功的控制
```
负载范围: 10-100 kW
P_max: 500 kW
Buffer: 5 kW

预期PV指令:
  min: 5 kW (当负载=10kW时)
  max: 95 kW (当负载=100kW时)
  平均: ≈ 负载均值 - 5
```

### 防逆流保证
```
在任何时刻:
  PV输出 ≤ P_cmd
  P_cmd ≤ 负载 - Buffer

因此:
  PV输出 ≤ 负载 - Buffer < 负载 ✅

绝对不会逆流！
```

## 📝 下一步

1. **重新启动应用**（已更新 P_max = 500）
2. **运行仿真**
3. **启用调试信息**
4. **查看计算详情表格**
5. **截图或告诉我你看到的数值**

我可以帮你分析为什么 P_cmd = 100！

---

**更新时间**: 2025年10月28日
**P_max 新默认值**: 500 kW
**调试功能**: ✅ 已添加
