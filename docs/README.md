# ⚡ V5 防逆流控制系统

基于 **STUKF（平滑趋势无迹卡尔曼滤波器）** 算法的光伏防逆流控制可视化平台。

## 🌟 项目特点

- ✅ **智能预测**: 基于 STUKF 算法的负载预测
- ✅ **安全可靠**: 非对称限速 + 安全旁路双重保护
- ✅ **现代设计**: 参考 Apple 设计语言的优雅界面
- ✅ **交互可视化**: 基于 Plotly 的动态图表
- ✅ **性能分析**: 全面的 KPI 指标和统计分析

## 📋 功能模块

### 1. 核心算法
- **STUKF 滤波器**: 实时负载预测和置信区间估计
- **V5 控制器**: 三层上界约束 + 非对称限速控制
- **安全机制**: 自动触发安全旁路保护

### 2. 用户界面
- **参数配置**: 灵活的控制参数调整
- **数据输入**: 支持 CSV/Excel 文件上传或生成示例数据
- **实时仿真**: 快速运行并展示控制效果

### 3. 可视化分析
- **时间序列图**: 负载、PV指令、预测值、上界对比
- **控制效果图**: 原始负载 vs 净负载对比
- **弃光分析**: 弃光功率时序和分布统计
- **变化率分析**: 上调/下调速率分布直方图

## 🚀 快速开始

### 环境要求
- Python 3.8+
- pip 或 conda 包管理器

### 安装步骤

1. **克隆或下载项目**
```bash
cd fnl_v2
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **运行应用**
```bash
streamlit run app.py
```

4. **访问界面**
   - 浏览器会自动打开 `http://localhost:8501`
   - 如未自动打开，请手动访问该地址

## 📁 项目结构

```
fnl_v2/
├── app.py                  # 主应用程序
├── stukf.py               # STUKF 算法实现
├── v5_anti_backflow.py    # V5 防逆流控制算法
├── visualization.py       # 可视化模块
├── styles.py              # Apple 风格 CSS
├── requirements.txt       # 依赖包列表
├── 需求.txt               # 项目需求文档
├── 算法架构.txt           # 算法架构说明
└── README.md             # 项目说明文档
```

## 📊 使用指南

### 1. 数据准备

**方式一：使用示例数据**
- 勾选"使用示例数据"
- 选择时长（1-48小时）
- 点击"生成示例数据"

**方式二：上传自定义数据**
- 准备 CSV 或 Excel 文件
- 必须包含两列：
  - `time`: 时间戳（秒）
  - `load`: 负载功率（kW）

### 2. 参数配置

**基础参数**:
- **Buffer (安全余量)**: 5-10 kW，防止逆流的安全裕量
- **R↑ (上行斜率)**: 5-20 kW/s，限制 PV 指令上升速度
- **R↓ (下行斜率)**: 30-100 kW/s，限制 PV 指令下降速度
- **α (置信度)**: 1e-4 ~ 1e-3，越小越保守
- **P_max**: 逆变器最大功率

**高级参数**（可选）:
- **S_down_max**: 负载最大下行速率（确定性约束）
- **延迟参数**: 测量/通信/执行延迟

### 3. 运行仿真

1. 点击侧边栏的 **"▶️ 运行仿真"** 按钮
2. 等待仿真完成（显示进度条）
3. 查看结果分析

### 4. 结果分析

**关键指标**:
- 总弃光量 (kWh) 和弃光率 (%)
- 最大弃光功率 (kW)
- 安全旁路触发次数
- 平均/最大上调和下调速率

**可视化图表**:
- 时间序列对比图（可选显示预测值和上界）
- 控制效果分析（净负载对比）
- 弃光分析（时序 + 分布）
- 变化率统计（直方图）

**数据导出**:
- 下载仿真结果 CSV
- 下载性能指标 CSV

## 🔧 算法原理

### STUKF 预测器
采用无迹卡尔曼滤波器（UKF）对负载进行实时预测：
- 状态向量: [L, dL/dt, d²L/dt²]
- 输出: 预测均值 L_med 和置信下界 L_lb

### V5 控制律

1. **安全上界 U_A**:
   - 确定性上界: U_A1 = L_t - S_down_max × H - Buffer
   - 概率性上界: U_A2 = L_lb - Buffer
   - 取两者较小值

2. **性能上界 U_B**:
   - U_B = L_med - Buffer
   - 防止过度保守

3. **非对称限速**:
   - 上行: 不超过 R↑
   - 下行: 不超过 R↓，但安全旁路时可瞬降

4. **最终控制律**:
```
如果 U < P_cmd_prev:
    P_cmd = U  (安全旁路)
否则:
    P_cmd = clip(U, [L_ramp, U_ramp])
```

## 🎨 设计特色

### Apple 风格设计元素
- **简洁布局**: 大量留白，清晰层次
- **优雅字体**: Inter / SF Pro Display
- **柔和配色**: 参考 Apple 调色板
  - 主色调: #007AFF (蓝色)
  - 成功: #34C759 (绿色)
  - 警告: #FF9500 (橙色)
  - 危险: #FF3B30 (红色)
- **流畅动画**: 悬停效果、过渡动画
- **圆角卡片**: 8-16px 圆角半径
- **精致阴影**: 多层次阴影效果

## 📈 性能优化建议

1. **Buffer 参数标定**:
```
Buffer ≥ k_σ × σ_L + |dL/dt|_q × Σ(τ) + ε_meter
```
- k_σ = 4~5
- σ_L: 负载短窗标准差
- |dL/dt|_q: 99% 分位变化率

2. **α 置信度选择**:
- 年逆流秒数 ≈ 0: α = 1e-4 ~ 1e-5
- 有储能兜底: α = 1e-3

3. **R↑ 上行限速**:
- 不超过负载典型下行斜率的 0.8-0.9 倍

## ⚠️ 注意事项

1. 确保输入数据质量，时间戳连续
2. Buffer 参数需根据现场情况标定
3. 存在断路等硬跳变时不应设定 S_down_max
4. 建议先用示例数据测试参数效果

## 📄 许可证

本项目仅用于学习和研究目的。

## 👤 作者

V5 防逆流控制系统开发团队

## 🙏 致谢

- STUKF 算法参考相关学术研究
- UI 设计参考 Apple Design Guidelines
- 使用 Streamlit + Plotly 开源框架

---

**Powered by STUKF Algorithm** ⚡
