# 数据格式更新总结

## ✅ 已完成的功能

### 1. 智能列名识别

系统现在可以自动识别多种列名格式，无需手动修改数据文件！

**支持的时间列名**:
- `UTC时间` ✅（你的格式）
- `UTC`
- `time`
- `时间`
- `时间戳`
- `timestamp`
- `datetime`
- `Time`
- `DateTime`

**支持的负载列名**:
- `负载数据` ✅（你的格式）
- `load`
- `负载`
- `power`
- `功率`
- `kW`

### 2. 完整数据清洗流程

#### ✅ 缺失值处理
- 自动检测空值、NaN
- **前向填充**：用上一个有效值填充
- 如果开头缺失，使用后向填充
- 显示缺失值数量和百分比

#### ✅ 异常大值处理 (>10000)
- 自动检测超过 10000 的数据
- 标记为无效值
- 使用前向填充替换
- 显示异常值数量

#### ✅ 负值处理
- 检测负载 < 0 的数据
- 标记为无效值
- 前向填充修正

#### ✅ 数据平滑
- **3点移动平均**平滑处理
- 减少噪声
- 居中对齐，减少延迟

#### ✅ 范围限制
- 最小值：0 kW
- 最大值：10000 kW

### 3. 数据质量报告

上传数据后会自动显示：

```
检测到的列: 时间戳, UTC时间, 设备地址, 设备类型, 负载数据

📊 数据质量报告：
  • 缺失值: 10 个 (0.5%)
  • 负值: 3 个 (0.15%)
  • 异常大值(>10000): 5 个 (0.25%)

🔧 正在进行数据清洗和平滑处理...

✓ 数据清洗完成: 保留 2000 条数据

✅ 成功加载并处理 2000 条数据

┌──────────────┬──────────────┐
│ 时间范围     │ 24.00 小时   │
│ 数据点数     │ 2,000        │
│ 负载均值     │ 52.3 kW      │
│ 负载范围     │ 0.0 ~ 100.5  │
└──────────────┴──────────────┘
```

### 4. 处理详情展示

可展开查看：
- 前10条数据的对比（原始 vs 处理后）
- 统计指标对比表
- 数据质量变化

### 5. UTC时间自动转换

- 自动解析 UTC 时间字符串
- 转换为相对秒数（从第一个时间点开始）
- 支持多种日期时间格式

## 📁 你的数据格式完全支持

```csv
时间戳,UTC时间,设备地址,设备类型,负载数据
1,2024-01-01 00:00:00,001,PV,45.2
2,2024-01-01 00:00:01,001,PV,46.1
3,2024-01-01 00:00:02,001,PV,      ← 缺失值，会被前向填充
4,2024-01-01 00:00:03,001,PV,-10  ← 负值，会被修正
5,2024-01-01 00:00:04,001,PV,15000 ← >10000，会被修正
6,2024-01-01 00:00:05,001,PV,47.3
```

**系统会自动**:
1. ✅ 识别 `UTC时间` 列作为时间
2. ✅ 识别 `负载数据` 列作为负载
3. ✅ 忽略其他列（`时间戳`、`设备地址`、`设备类型`）
4. ✅ 清洗所有异常数据
5. ✅ 应用平滑处理

## 🚀 使用方法

### 步骤 1: 启动应用
```bash
streamlit run app.py
```

### 步骤 2: 上传数据
1. 取消勾选"使用示例数据"
2. 点击文件上传器
3. 选择你的 CSV 或 Excel 文件

### 步骤 3: 查看处理结果
- 自动显示检测到的列
- 显示数据质量报告
- 显示清洗结果
- 显示统计信息

### 步骤 4: 展开详情（可选）
- 点击"查看数据处理详情"
- 查看处理前后对比
- 查看统计指标变化

### 步骤 5: 运行仿真
- 调整参数（如需要）
- 点击"运行仿真"
- 查看结果

## 📊 处理示例

### 输入数据（有问题）
```
UTC时间                负载数据
2024-01-01 00:00:00   45.2
2024-01-01 00:00:01        ← 缺失
2024-01-01 00:00:02   -5   ← 负值
2024-01-01 00:00:03   15000 ← 异常大
2024-01-01 00:00:04   47.3
2024-01-01 00:00:05   46.8
```

### 输出数据（已清洗）
```
时间(s)  处理后负载
0        45.2
1        45.2  ← 前向填充
2        45.2  ← 前向填充
3        45.2  ← 前向填充
4        47.3
5        46.8
```

### 平滑处理（3点移动平均）
```
处理后负载  平滑后负载
45.2       45.2
45.2       45.2
45.2       45.9  ← (45.2+45.2+47.3)/3
47.3       46.4  ← (45.2+47.3+46.8)/3
46.8       46.8
```

## 🔍 技术细节

### 前向填充算法
```python
# Pandas forward fill
df['load'] = df['load_raw'].fillna(method='ffill')

# 相当于
for i in range(1, len(df)):
    if pd.isna(df.loc[i, 'load']):
        df.loc[i, 'load'] = df.loc[i-1, 'load']
```

### 移动平均平滑
```python
df['load_smoothed'] = df['load'].rolling(
    window=3,      # 窗口大小
    min_periods=1, # 最小数据点
    center=True    # 居中对齐
).mean()
```

## ⚠️ 注意事项

1. **数据顺序很重要**
   - 前向填充依赖时间顺序
   - 确保数据按时间排序

2. **第一个数据点**
   - 如果第一个就是异常，会用第一个有效值

3. **连续异常**
   - 多个连续异常会被替换为最近的有效值

4. **平滑影响**
   - 会轻微改变峰值
   - 对快速变化有平滑作用

## 📝 更新文件

已修改的文件：
- ✅ `app.py` - 升级 `load_data()` 函数

新增的文件：
- ✅ `DATA_PROCESSING.md` - 数据处理说明

## 🎯 下一步

你现在可以：
1. 重新启动应用：`streamlit run app.py`
2. 上传你的实际数据文件
3. 系统会自动处理所有问题
4. 查看清洗结果和统计
5. 运行仿真

如果遇到任何问题，系统会显示详细的错误信息！

---

**更新完成时间**: 2025年10月28日
**功能状态**: ✅ 已实现并准备测试
