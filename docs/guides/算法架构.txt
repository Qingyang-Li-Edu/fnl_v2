1）算法：只依赖总负载，可直接落地实现
算法的出发点很简单：
在只能实时读取总负载 $$L_t$$ 的前提下，动态算出一个“安全又不太保守”的光伏限发指令。
算法逻辑非常纯粹——
 输入是当前负载和历史序列，输出是下一步光伏限发功率。
 中间通过三个核心模块来“夹紧”这个值：
1. 安全上界（Safety Ceiling）：保证不逆流。
2. 性能上界（Performance Ceiling）：避免过于保守。
3. 非对称限速（Ramp Limit）：控制变化速率，防止过冲。

1.1 输入与主要参数
实时可读量
- 当前总负载
- $$L_t\ \text{(kW)}$$
控制与已知参数
- 上一周期下发的 PV 限发指令$$P_t^{cmd}\ \text{(kW)}$$
- 逆变器最大可发功率$$P^{max}\ \text{(kW)}$$
- 当前周期长度（由时间戳计算，可存在抖动）$$\Delta t\ \text{(s)}$$
- 命令生效的等效时域（考虑测量、通信、执行延迟）$$H = \Delta t + \tau_{meas} + \tau_{com} + \tau_{exec}$$
估计器（STUKF）
STUKF 只用负载历史序列 $$(t_k, L_k)$$ 进行预测，在线更新：
- 未来 $$H$$ 秒的均值预测：$$\tilde{L}_{t+H}$$
- 未来 $$H$$ 秒的低分位预测（例如 99.9% 置信下界）：$$L_{t+H}^{(1-\alpha)}$$
控制参数
- 安全余量（Buffer，单位：kW）
- 上行斜率上限$$R_\uparrow\ \text{(kW/s)}$$
- 下行斜率上限（一般取很大）$$R_\downarrow\ \text{(kW/s)}$$
- 可选项：负载最快下行速率上界$$⁡S_{\downarrow}^{\max}$$

1.2 三类上界的构造逻辑
我们定义三个“上界”，它们的物理含义不同，但都只依赖负载数据。
对应系统提供三种选择
(1) 确定性安全上界（如果提供 $$S_{\downarrow}^{\max}$$）
假设负载未来最多下降 $$S_{\downarrow}^{\max}\cdot H$$，
 则即使最剧烈暴跌，也不会低于下式：$$U_{A1} = \max(0,\ L_t -S_{\downarrow}^{\max}\cdot H)- Buffer$$ 
这个上界保证“无论未来怎么跌，也不逆流”。
(2) 概率性安全上界（由 STUKF 给出）
如果我们只相信 STUKF 的统计结果，那么用低分位预测：$$U_{A2} = L_{t+H}^{(1-\alpha)}- Buffer$$ 
这意味着有 $$1-\alpha$$ 的置信度不逆流，一般取 $$\alpha = 10^{-3}!\sim!10^{-4}$$。
(3) 性能上界（防止过度保守）
为了避免 PV 限得太死，我们再加一个“性能天花板”：$$U_B = \tilde{L}_{t+H}- Buffer$$ 
它不会直接决定安全，只在有“上行意图”时参与。

1.3 上界合成与物理约束
若系统配置了 $$S_{\downarrow}^{\max}$$，则取更保守的安全界：
$$U_A = \min(U_{A1},\ U_{A2})UA=min(UA1, UA2)$$
若没有确定性上界，则直接取：$$U_A = U_{A2}$$
同时考虑逆变器的物理极限：$$U = \min(U_A,\ P^{max})$$
1.4 上界合成与物理约束
若系统配置了 $$S_{\downarrow}^{\max}$$，则取更保守的安全界：
$$U_A = \min(U_{A1},\ U_{A2})$$
若没有确定性上界，则直接取：
$$U_A = U_{A2}$$
同时考虑逆变器的物理极限：
$$U = \min(U_A,\ P^{max})$$
1.3 非对称限速与安全旁路机制
我们给上下行分别设限速：
- 上行限速（防止追得过快）：$$ΔtU_{ramp} = P_t^{cmd} + R_\uparrow\cdot\Delta t$$
- 下行限速（防止急降，法规无要求可取大）：$$L_{ramp} = P_t^{cmd} - R_\downarrow\cdot\Delta t$$
但有一种特殊情况需要“安全旁路”：
 如果当前上界 $$U$$ 已经低于现指令 $$P_t^{cmd}$$，
 为了立即保证不逆流，允许直接砍到 $$U$$，忽略 $$R_\downarrow$$ 限速。
 
 1.4 最终控制律（核心执行逻辑）
我们首先判断是否存在“上行意图”：
$$up = (U > P_t^{cmd}) \quad \text{或} \quad (\tilde{L}_{t+H} > P_t^{cmd})$$
若存在上行意图，则夹紧上界：
$$U \leftarrow \min(U,\, U_B)$$
最终下发指令如下：
$$P_{t+1}^{cmd} = 
\begin{cases} 
\max(0,\ \min(U,\ P^{max})), & U < P_t^{cmd} \quad \text{（安全旁路）} \\ 
\max(\max(0,\ L_{ramp}),\ \min(U,\ U_{ramp})), & \text{否则}
\end{cases}$$
直观理解：
- 任何时刻都不能超过安全上界 $$U_A$$；
- 上行时再受性能上界 $$U_B$$ 与上行限速 $$R_\uparrow$$ 抑制；
- 下行时优先安全，必要可瞬砍。

1.6 参数标定建议（上线前一次算准）
- $$H$$：由实际时间戳间隔 $\Delta t$ 加上测量、通信、执行三项延迟。上线前可通过 ping 或动作回放测定。
- Buffer（安全裕量）：
- $$Buffer \ge k_\sigma \sigma_L + |\dot{L}|_q\cdot(\tau_{meas}+\tau_{com}+\tau_{exec}) + \epsilon_{meter}$$
  - $$\sigma_L$$：负载短窗标准差；
  - $$k_\sigma = 4\sim5$$；
  - $$|\dot{L}|_q$$：负载一秒变化的 $$q$$ 分位（建议 $$q=99\%$$）；
  - $$\epsilon_{meter}$$：表计误差。
- $$S_{\downarrow}^{\max}$$（可选）：
 从历史极端 $$|\dot{L}|$$ 的 99.9% 分位乘以 1.1–1.3 安全系数得到。
 若现场存在断路或跳负荷等硬跳变，则不应设定该上界。
- $$\alpha$$：
 若目标是“年逆流秒数≈0”，取 $$10^{-4}!\sim!10^{-5}$$；
 若系统有储能兜底，可放宽到 $$10^{-3}$$。
- $$R_\uparrow$$：
 不超过负载典型下行斜率的 0.8–0.9 倍。
- $$R_\downarrow$$：
 法规若无要求，取极大值即可（相当于允许瞬降）。
 
 1.7 异常与边界处理
- 若检测到 $$L_t \le 0$$ 或负载数据异常，立即下发：
- $$P_{t+}^{cmd} = 0$$
- 若 STUKF 方差飙升或发散：
  - 增大 Buffer；
  - 或提高 $$\alpha$$（更保守）；
  - 若配置了 $$S_{\downarrow}^{\max}$$，也可暂时只用确定性上界 $$U_{A1}$$。
- 若逆变器因强日照无法达到指令，即实际输出 $$P^{act}\le P^{cmd}$$
 这种情况更安全，不会引发逆流。