# 数据处理功能说明

## 📊 智能数据清洗和平滑处理

系统已升级，现在支持自动处理有问题的数据！

### ✅ 支持的数据格式

#### 列名自动识别

**时间列**（任意一个即可）:
- `UTC时间`
- `UTC`
- `time`
- `时间`
- `时间戳`
- `timestamp`
- `datetime`
- `Time`
- `DateTime`

**负载列**（任意一个即可）:
- `负载数据`
- `load`
- `负载`
- `power`
- `Load`
- `Power`
- `功率`
- `kW`

### 🔧 自动数据清洗流程

系统会自动处理以下数据问题：

#### 1. **缺失值处理**
- **识别**: 自动检测空值（NaN、空字符串等）
- **处理**: 使用前向填充（Forward Fill）
  - 用上一个有效值填充缺失值
  - 如果开头有缺失，使用后向填充
- **显示**: 显示缺失值数量和百分比

#### 2. **异常大值处理 (>10000)**
- **识别**: 检测超过 10000 的数据
- **处理**:
  - 标记为无效值
  - 使用前向填充替换
- **显示**: 显示异常大值数量和百分比

#### 3. **负值处理**
- **识别**: 检测小于 0 的负载数据
- **处理**: 标记为无效值，使用前向填充
- **显示**: 显示负值数量和百分比

#### 4. **数据平滑**
- **方法**: 3点移动平均平滑
- **效果**: 减少数据噪声，使曲线更平滑
- **参数**: 窗口大小 = 3，居中对齐

#### 5. **范围限制**
- **最小值**: 0 kW
- **最大值**: 10000 kW
- **处理**: 自动裁剪超出范围的值

### 📈 数据质量报告

上传数据后，系统会自动显示：

1. **检测到的列名**
   - 显示文件中所有列名
   - 标识识别到的时间列和负载列

2. **数据质量报告**（如有问题）
   ```
   📊 数据质量报告：
     • 缺失值: X 个 (X.X%)
     • 负值: X 个 (X.X%)
     • 异常大值(>10000): X 个 (X.X%)
   ```

3. **清洗结果**
   ```
   ✓ 数据清洗完成: 原始数据量 → 处理后数据量
   ```

4. **数据统计**
   - 时间范围（小时）
   - 数据点数
   - 负载均值
   - 负载范围

5. **处理详情**（可展开查看）
   - 前10条数据的处理前后对比
   - 原始数据 vs 处理后数据
   - 统计指标对比表

### 💡 示例

#### 原始数据（有问题）
```csv
时间戳,UTC时间,设备地址,设备类型,负载数据
1,2024-01-01 00:00:00,001,PV,45.2
2,2024-01-01 00:00:01,001,PV,
3,2024-01-01 00:00:02,001,PV,-10.5
4,2024-01-01 00:00:03,001,PV,15000
5,2024-01-01 00:00:04,001,PV,47.3
```

**问题**:
- 第2行：缺失值
- 第3行：负值 (-10.5)
- 第4行：异常大值 (15000 > 10000)

#### 处理后数据
```
时间(s), 处理后负载
0,       45.2
1,       45.2  ← 前向填充
2,       45.2  ← 前向填充
3,       45.2  ← 前向填充
4,       47.3
```

### 🎯 处理逻辑

```python
# 1. 标记异常值
data[data > 10000] = NaN
data[data < 0] = NaN

# 2. 前向填充
data = data.fillna(method='ffill')

# 3. 后向填充（处理开头缺失）
data = data.fillna(method='bfill')

# 4. 移动平均平滑
data = data.rolling(window=3, center=True).mean()

# 5. 范围限制
data = data.clip(0, 10000)
```

### 📊 数据质量对比表

系统会自动生成对比表：

| 指标 | 原始数据 | 处理后 |
|------|---------|--------|
| 最小值 | -10.5 | 0.0 |
| 最大值 | 15000 | 100.5 |
| 平均值 | 3012.5 | 52.3 |
| 标准差 | 6500.2 | 15.8 |
| 中位数 | 46.0 | 46.2 |

### ⚙️ 自定义选项（未来功能）

计划支持的自定义选项：
- [ ] 异常值阈值（当前固定 10000）
- [ ] 平滑窗口大小（当前固定 3）
- [ ] 填充方法选择（前向/后向/插值）
- [ ] 是否启用平滑
- [ ] 离群点检测方法

### 🚨 注意事项

1. **前向填充的局限性**
   - 如果第一个数据就是缺失/异常，会使用后续的第一个有效值
   - 连续多个异常值会被替换为最近的有效值

2. **平滑处理的影响**
   - 会轻微改变数据的峰值
   - 对突变信号有平滑作用
   - 3点窗口影响较小

3. **数据完整性**
   - 系统不会删除数据行
   - 所有异常值都会被修正
   - 保持原始时间序列长度

### 📝 使用建议

1. **查看数据质量报告**
   - 上传后先查看报告
   - 了解数据问题的严重程度

2. **展开处理详情**
   - 查看处理前后对比
   - 验证处理结果是否合理

3. **检查统计指标**
   - 对比处理前后的统计特性
   - 确保没有过度平滑

4. **如果数据质量太差**
   - 考虑重新采集数据
   - 或在源头解决数据问题

---

**更新时间**: 2025年10月28日
**功能状态**: ✅ 已实现并测试
